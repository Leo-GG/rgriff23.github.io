---
title: "Visualizing the primate phylogeny with ggtree"
layout: post
date: 2017-05-21
tags: R tutorial phylogeny primates ggtree phytools 
comments: true
---

```{r setup, include=FALSE, message=FALSE}
# knitr settings
#knitr::opts_chunk$set(fig.path = "assets/Rfigs/", message=FALSE, comment=" ")
#knitr::opts_knit$set(base.dir = "/Users/nunnlab/Desktop/GitHub/rgriff23.github.io/", base.url = "/")
knitr::opts_chunk$set(message=FALSE, comment=" ", cache=TRUE)

# load packages 
library("phytools")
library("ggtree")
library("EBImage")
```

The `ggtree` package on [Bioconductor](https://www.bioconductor.org/packages/devel/bioc/vignettes/ggtree/inst/doc/ggtree.html) is a welcome extension of `ggplot2` for visualizing and annotating phylogenies. Its best feature is the ability to easily annotate trees with text, labels, images, and most excitingly, plots within plots (i., 'subplots'). For example, you can annotate internal nodes with histograms to display posterior distributions of continuous ancestral state estimates, or you can annotate tips with scatterplots depicting within-speies allometric relationships. In this tutorial, I build some fancy primate phylogeny plots that demonstrate the features of `ggtree` I have found most useful for displaying comparative data and ancestral state reconstructions (ASRs). I also cover how to add images to the phylogeny. A thorough overview of `ggtree` capabilities can be found in the package [vignette](http://www.bioconductor.org/packages/3.1/bioc/vignettes/ggtree/inst/doc/ggtree.html).

### Preparations

Install `phytools` from CRAN, and  `EBImage` and `ggtree` from Bioconductor. Then load the packages:

```{r eval=FALSE}
# install from CRAN
install.packages("phytools")

# install from Bioconductor
source("https://bioconductor.org/biocLite.R")
biocLite("EBImage")
biocLite("ggtree")

# load packages
library("phytools") # for sims and ASRs
library("EBImage") # for images
library("ggtree")
```

Import the primate phylogeny from GitHub (this tree originally came from [10kTrees](https://10ktrees.fas.harvard.edu/)):

```{r, message=FALSE}
# read the tree from GitHub
tree <- read.nexus("https://raw.githubusercontent.com/rgriff23/Dissertation/master/Chapter_2/data/tree.nex")
```

### Basics

The simplest `ggtree` plot displays only branches:

```{r post_2017-05_ggtree_basic}
# basic plot
p1 <- ggtree(tree)
plot(p1)
```

The layout options available in `ggtree` are basically the same as those available in `ape`'s `plot.phylo` function, although the layout names are a bit different. Here are all the layouts, and also a demonstration of how easy it is to put multiple phylogenies in one plot using the `multiplot` function:

```{r post_2017-05_ggtree_basic2, fig.width=7.5, fig.height=5}
# show different layouts in multiplot
p2a <- ggtree(tree, layout="rectangular") + ggtitle("rectangular")
p2b <- ggtree(tree, layout="slanted") + ggtitle("slanted")
p2c <- ggtree(tree, layout="fan") + ggtitle("fan")
p2d <- ggtree(tree, layout="circular") + ggtitle("circular")
p2e <- ggtree(tree, layout="radial") + ggtitle("radial")
p2f <- ggtree(tree, layout="unrooted") + ggtitle("unrooted")
multiplot(p2a, p2b, p2c, p2d, p2e, p2f, ncol=3)
```

We have to add all other features related to the nodes, tips, and branches. This can be done by adding layers to the basic plot:

```{r post_2017-05_ggtree_basic3, fig.width=7, fig.height=7}
# add tip labels (making room with xlim first), node labels, background color, 
# branch colors (based on branch legths), and a legend for the branch colors
p3 <- ggtree(tree, aes(color=branch.length)) +
  xlim(0, 90) + 
  geom_tiplab(size=2, color="purple") +
  geom_label2(aes(subset=!isTip, label=node), size=2, color="darkred", alpha=0.5) +
  theme_tree2("black") +
  scale_color_continuous(low='white', high='hotpink', name="Branch length (my)") +
  theme(legend.position="bottom")
plot(p3)
```

This plot will be useful for identifying the node numbers necessary to label or draw attention to clades in the next section.

### Annotating clades

Using the last plot, we can see that these are the internal node numbers corresponding to the primate superfamilies:

- Node U: Galagoidea
- Node V: Lemuroidea
- Node W: Tarsioidea
- Node X: Ceboidea
- Node Y: Cercopithecoidea
- Node Z: Hominoidea

We can add information about these clades to the tree itself using the `groupClade` function, which will allow us to automatically add certain aesthetics across clades. Add the clades to the tree, and then use this to color the branches of the tree based on clade.

```{r}
# group clades

# plot tree with color coded clades

```

Perhaps the most obvious thing we can try is adding text labels to the nodes:

```{r post_2017-05_ggtree_clades1}

```

I think these labels are too long to be placed inside the tree like this. There are a couple of other approaches we can take. One would be to add a colorful shaded region around the clades:

```{r post_2017-05_ggtree_clades2}

```

Another would be to add bars near the tips of the tree that show the extent of each clade (note how I adjust the text size and position for the small Tarsiidae family):

```{r post_2017-05_ggtree_clades3}

```

Finally, we can label our clades with images. These can be any images that we choose, for example:

```{r post_2017-05_ggtree_clades4}

```

We can also use images from the `phylopic` database, which `ggtree` is designed to play well with. To annotate nodes with `phylopic`, first find the number of each node you want to annotate, then match each node with a link to an image on XXX. Here are the images I want to use for the major primate superfamilies:

-
-
-
-
-
-

Now add the images to the plot.

```{r post_2017-05_ggtree_clades5}

```

Next, we learn how to visualize data on the tips of the tree. 

### Annotating tips with comparative data

First, simulate some comparative data with `phytools`. For now, let's simulate one continuous and one binary trait.

```{r}
# make reproducible
set.seed(23)

# simulate continous trait
continuous.trait <- fastBM(tree)

# simulate binary trait 
binary.trait <- fastBM(tree)
binary.trait <- ifelse(binary.trait > mean(binary.trait), 1, 0)

```

Use symbols or bars to show a continuous character

The heatmap function for large data matrices

If you have multiple within-species samples, you can also use subplots to display the within-species distributions on the tips of the tree:

```{r}

```

### Displaying ASRs with subplots

Now we will perform some ancestral state reconstructions (ASRs) and visualize the results across nodes. First, estimate ASRs for one continuous and one binary trait:

```{r}
# continuous trait ASRs

# binary trait ASRs
```

For the continuous trait, ancestral states are represented by a continuous posterior distribution that can be visualized with a histogram. We can annotate our nodes with the histograms of the posterior distributions:

```{r}
# add continuous posterior distribution histograms
```

For the discrete trait, ancestral states can be represented by a pie chart or bar chart depicting the relative probability of each state. Here are both options:

```{r}
# add binary posterior distribution pies and bars
```



```{r, eval=FALSE}
# plot tree
fig <- ggplot(tree) + 
  geom_tree() + 
  theme_tree() + 
  geom_tiplab(list(tree$tip.label), size=2.5, offset=5) + 
  xlim(0,95) +
  geom_cladelabel(96, "Ceboidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5) +
  geom_cladelabel(70, "Cercopithecoidea", offset= 18, barsize=2, angle=90, offset.text = 1, hjust=0.5) +
  geom_cladelabel(113, "Lemuroidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5) +
  geom_cladelabel(124, "Galagoidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5) +
  geom_cladelabel(89, "Hominoidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5) +
  geom_cladelabel(110, "Tarsioidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5, fontsize = 3)
fig <- gheatmap(fig, tab, offset=0.1, width=0.05, low="white", high="black", colnames_position = "top", font.size=2.5)
fig <- phylopic(fig, "f598fb39-facf-43ea-a576-1861304b2fe4", node=110) # tarsiers
fig <- phylopic(fig, "aceb287d-84cf-46f1-868c-4797c4ac54a8", node=96) # nwm
fig <- phylopic(fig, "bac25f49-97a4-4aec-beb6-f542158ebd23", node=113) # lemurs
fig <- phylopic(fig, "7fb9bea8-e758-4986-afb2-95a2c3bf983d", node=124) # galagoids
fig <- phylopic(fig, "72f2f854-f3cd-4666-887c-35d5c256ab0f", node=70) # owm
fig <- phylopic(fig, "0174801d-15a6-4668-bfe0-4c421fbe51e8", node=89) # hominoids
fig + theme(legend.position="none")
```



### Concluding remarks

If you are in the business of plotting phylogenies, I think mastering `ggtree` is well worth the effort. I would also note that [`phytools`](http://blog.phytools.org/) (which we used here to simulate data and reconstruct ancestral states) also has some interesting functions for visualizing phylogenetic comparative data and ancestral state reconstructions- see this [demo](https://lukejharmon.github.io/ilhabela/instruction/2015/07/05/plotting-methods/). However, as a general toolkit for annotating phylogenies, `ggtree` is currently the most powerful and flexible R tool I am aware of.

**Footnotes**

Yu G, Smith D, Zhu H, Guan Y and Lam TT (2017). “ggtree: an R package for visualization and annotation of phylogenetic trees with their covariates and other associated data.” *Methods in Ecology and Evolution*, 8, pp. 28-36. doi: [10.1111/2041-210X.12628](http://onlinelibrary.wiley.com/doi/10.1111/2041-210X.12628/abstract). 
