---
title: "Plotting the primate phylogeny with ggtree (tutorial)"
layout: post
date: 2017-05-21
tags: R tutorial phylogeny primates visualization ggtree
comments: true
---

The second chapter of my dissertation includes a primate phylogeny, and since it is the only visual in the chapter, I wanted to do a little something extra. This lead me to `ggtree`, an R package on [Bioconductor](https://www.bioconductor.org/packages/devel/bioc/vignettes/ggtree/inst/doc/ggtree.html) for visualizing and annotating phylogenies. It basically does for phylogeny plots what `ggplot2` does for most other kinds of plots- it gives you a more sophisticated baseline appearance and better control over aesthetic features. 

Below, I demonstrate how to make a fancy primate phylogeny using `ggtree` with `phylopic` to annotate clades with images. 

### Preparations

If necessary, install `ape` from CRAN, and `ggtree` and `EBImage` from Bioconductor, and load the packages:

```{r eval=FALSE}
# install from CRAN
install.packages("ape")

# install from Bioconductor
source("https://bioconductor.org/biocLite.R")
biocLite("ggtree")
biocLite("EBImage")

# load packages
library(ape) # for 'read.nexus'
library(ggtree)
library(EBImage) # for images
```

Import the primate phylogeny from GitHub (it originally came from [10kTrees]()):

```{r, message=FALSE}
# read the tree from GitHub
tree <- read.nexus("https://raw.githubusercontent.com/rgriff23/Dissertation/master/Chapter_2/data/tree.nex")
```

This tree has full species names in the form `Genus_species`. Since there is just one representative species for each genus in this tree, I want to shorten the tip labels to just the genus name:

```{r}
# set tree labels to genus name only
tree$tip.label <- sapply(strsplit(tree$tip.label, "_"), "[[", 1)
```

And as our final preparation step, let's create some fake data to plot on the tips of the tree: 3 continuous variables, and 3 binary variables.

```{r}
# make reproducible
set.seed(23)

# 3 continuous variables
tip.data <- data.frame(var1=rnorm(length(tree$tip.label)))
tip.data$var2 <- rnorm(length(tree$tip.label))
tip.data$var3 <- rnorm(length(tree$tip.label))

# 3 binary variables
tip.data$var4 <- sample(c(0,1), length(tree$tip.label), replace=TRUE)
tip.data$var5 <- sample(c(0,1), length(tree$tip.label), replace=TRUE)
tip.data$var6 <- sample(c(0,1), length(tree$tip.label), replace=TRUE)
```

Now we can start plotting! I will note that there is a perfectly lovely tutorial from the `ggtree` package author [here](), which is how I learned to do all of this. Nothing I am demonstrating here goes beyond what is covered in that tutorial. But my tutorial IS about primates, so...

### Plots?

```{r}
# plot tree
fig <- ggplot(tree) + 
  geom_tree() + 
  theme_tree() + 
  geom_tiplab(list(tree$tip.label), size=2.5, offset=5) + 
  xlim(0,95) +
  geom_cladelabel(96, "Ceboidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5) +
  geom_cladelabel(70, "Cercopithecoidea", offset= 18, barsize=2, angle=90, offset.text = 1, hjust=0.5) +
  geom_cladelabel(113, "Lemuroidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5) +
  geom_cladelabel(124, "Galagoidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5) +
  geom_cladelabel(89, "Hominoidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5) +
  geom_cladelabel(110, "Tarsioidea", offset= 18, barsize=2, angle=90, offset.text = 1.2, hjust=0.5, fontsize = 3)
fig <- gheatmap(fig, tab, offset=0.1, width=0.05, low="white", high="black", colnames_position = "top", font.size=2.5)
fig <- phylopic(fig, "f598fb39-facf-43ea-a576-1861304b2fe4", node=110) # tarsiers
fig <- phylopic(fig, "aceb287d-84cf-46f1-868c-4797c4ac54a8", node=96) # nwm
fig <- phylopic(fig, "bac25f49-97a4-4aec-beb6-f542158ebd23", node=113) # lemurs
fig <- phylopic(fig, "7fb9bea8-e758-4986-afb2-95a2c3bf983d", node=124) # galagoids
fig <- phylopic(fig, "72f2f854-f3cd-4666-887c-35d5c256ab0f", node=70) # owm
fig <- phylopic(fig, "0174801d-15a6-4668-bfe0-4c421fbe51e8", node=89) # hominoids
fig + theme(legend.position="none")
```

Let's start with a basic plot with different layouts.

You can tinker with the usual graphical parameters (node/tip labels/colors/symbols, branch labels/colors, tip data).

You can annotate clades.

You can add more features like a legend, scale bar, other stuff?

Now, let's annotate the tree with the color-coded tip data, and add a legend for the tip data. 

To annotate nodes with images, first find the number of each node you want to annotate, then match each node with a link to an image on XXX. Here are the node numbers and images for the major primate superfamilies:



Now we can add these images to the plot.

```{r}

```

And that's it! Overall, I find that `ggtree` greatly increases the ease and flexibility of adding features to trees, and I think the trees generally look nicer. If you're in the business of plotting trees, I'd say learning `ggtree` is worth the effort. 

**Footnotes**

Yu G, Smith D, Zhu H, Guan Y and Lam TT (2017). “ggtree: an R package for visualization and annotation of phylogenetic trees with their covariates and other associated data.” *Methods in Ecology and Evolution*, 8, pp. 28-36. doi: [10.1111/2041-210X.12628](http://onlinelibrary.wiley.com/doi/10.1111/2041-210X.12628/abstract). 
