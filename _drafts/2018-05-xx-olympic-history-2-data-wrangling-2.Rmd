---
title: 'Olympic history: Data wrangling (part 2)'
date: "2018-05-xx"
layout: post
tags: R olympics sports tidyverse
comments: yes
---

```{r setup, include=FALSE, message=FALSE}
# knitr settings
knitr::opts_chunk$set(fig.path = "assets/Rfigs/", message=FALSE, comment="> ", fig.align='center')
knitr::opts_knit$set(base.dir = "/Users/nunnlab/Documents/GitHub/rgriff23.github.io/", base.url = "/")
```

```{r, include=FALSE}
# load packages & data
library("tidyverse")
library("data.table")
load("~/Documents/GitHub/Olympic_history/data/scrapings.Rdata")

# There are 135584 athletes in the database
n_athletes <- infobox %>% length

# Create new tibble with one column: Name
info <- infobox %>% 
  lapply(function(x) strsplit(x[[1]], ": ")[[1]][2]) %>% unlist %>%  tibble(Name = .)

# Name variable
info <- infobox %>% 
  lapply(function(x) {
    x <- x[grep("Gender:",x)] 
    if (length(x) == 0) {
      sex <- "M"
      } else {
        sex <- grepl("Female",x) %>% 
          ifelse("F","M")
      }
    return(sex)
  }) %>% unlist %>% factor %>% add_column(info, Sex = .)
# Manually fix females with missing data
info$Sex[c(30521, 42623, 47015, 81716)] <- "F"

# Height variable
info <- infobox %>% 
  lapply(function(x) {
    x <- x[grep("Height:",x)] 
    if (length(x) > 0) {
      x <- gsub(".*\\((.*)\\).*", "\\1", x)
      height <- as.numeric(gsub(" cm", "", x))
    } else {height <- NA}
    return(height)
  }) %>% unlist %>% add_column(info, Height = .)

# Weight variable
info <- infobox %>% 
  lapply(function(x) {
    x <- x[grep("Weight:",x)] 
    if (length(x) > 0) {
      if (length(grep("lbs", x)) == 1) {
        x <- gsub(".*\\((.*)\\).*", "\\1", x)
        weight <- as.numeric(gsub(" kg", "", x))
      } else {
        x <- strsplit(x, " ")[[1]]
        if (length(x) == 3) {
          weight <- strsplit(x[[2]],"-")[[1]] %>% as.numeric %>% mean
        } else if (length(x) == 4) {
          weight <- c(gsub(",","",x[2]),x[3]) %>% as.numeric %>% mean
        } else if (length(x) == 5) {
          weight <- c(gsub(",","",x[2:3]),x[4]) %>% as.numeric %>% mean
        } else weight <- -1
      }
    } else weight <- NA
    return(weight)
  }) %>%
  unlist %>% add_column(info, Weight = .)
# Fix the one problematic entry
info$Weight[which(sums==1)] <- 77.5 

# Drop NULL entries from both info and results
nulls <- which(results_table %>% lapply(is.null) %>% unlist) 
info <- info[-nulls,]
results_table <- results_table[-nulls]

# Keep columns of interest (drop 'Rank' and empty final column)
keep <- c("Games", "Age", "City", "Sport", "Event", "Team", "NOC", "Medal")
results_table <- lapply(results_table, function (x) {x[,keep]})

# Add an ID column to the 'info' dataframe
info$ID <- as.character(1:nrow(info))

# Use the same ID variable to name the elements in 'results_table'
results_table <- setNames(results_table, info$ID)

# Use 'rbindlist' from the 'data.table' package to convert 'results_table'
# to a dataframe with the element names as an ID column
data <- rbindlist(results_table, use.names=TRUE, idcol="ID") 

# join 'info' and 'results_table' by the ID column
data <- right_join(info, data, by="ID")

# Games must be a character vector to use 'gsub'
data$Games <- data$Games %>% as.character

# Replace letters after the space with ""
data$Year <- data$Games %>% gsub(" [A-z]*", "", .) %>% as.numeric

# Replace digits before the space with ""
data$Season <- data$Games %>% gsub("[0-9]* ", "", .)

# Reorder the variables
data <- data[,c("ID","Name","Sex","Age","Height","Weight","Team","NOC","Games","Year","Season","City","Sport","Event","Medal")]
```

In my last post, I scraped data on 135,584 Olympic athletes from www.sports-reference.com, and the data was saved in two lists containing information on each athlete in different formats. In its present form, the data is pretty useless. In this post, I tidy up this data so that it can actually be analyzed. 

Normally, this part of my work flow would get buried in a file somewhere that I'd expect nobody to ever look at. However, a big part of my motivation for doing this project was learning `tidyverse`, and the data wrangling stage was one of the places where I felt the advantages of `tidyverse` the most, so I'm going to dive into the wrangling this once. If you aren't interested in the wrangling and you just want to see pretty plots about Olympic history, then stay tuned for my later posts in which I analyze the prettied-up data.

## Set up

To follow along with this code, you must start by importing the data and running the code in the [previous post](). 

## Check variables for weird values

```{r}
# Check for weird values
data$Sex %>% unique # M and F
data$Age %>% unique # convert this to integer type
data$Height %>% range(na.rm=TRUE)
data$Weight %>% range(na.rm=TRUE) # smallest person was 55 lbs??
data$Team %>% unique # 1184 levels - this may not be a useful variable
data$NOC %>% unique # 230 levels
data$Games %>% unique # 52 levels
data$Year %>% unique # 35 levels
data$Season %>% unique # there is an 'Equestrian' value (also in Games variable)
# These are for the 1956 Games in Stockholm, in which equestrian was held 5 months earlier
# And in a different city than the rest of the Summer Games, which were in Melbourne
# I will replace these values with 'Summer'
data$City %>% unique # 42 levels - bad text encoding should be fixed
data$Sport %>% unique # 66 levels
data$Event %>% unique # 679 levels - bad text encoding should be fixed
data$Medal %>% unique # replace "" with NA

# Name and Team variables contain a lot of non-ascii characters which I will remove
data$Name <- data$Name %>% iconv("UTF-8","ASCII", sub="")
data$Team <- data$Team %>% iconv("UTF-8","ASCII", sub="")

# Convert Age variable to integer type
data$Age <- data$Age %>% parse_integer

# Change 'Equestrian' to 'Summer' in Games and Season variables
data$Games[data$Games == "1956 Equestrian"] <- "1956 Summer"
data$Season[data$Season == "Equestrian"] <- "Summer"
data$Season <- data$Season %>% as.factor

# Replace "" with NA in Medal variable
data$Medal[data$Medal == ""] <- NA

# Fix text encoding for cities
cities <- data$City %>% unique
problem_cities <- cities[c(24,25,33)]
correct_cities <- c("Mexico City","Munich","Montreal")
data$City <- data$City %>% as.character
data$City[data$City == problem_cities[1]]  <- correct_cities[1]
data$City[data$City == problem_cities[2]]  <- correct_cities[2]
data$City[data$City == problem_cities[3]]  <- correct_cities[3]
data$City <- data$City %>% as.factor

# Fix text encoding for events
events <- data$Event %>% unique
problem_events <- events[c(10,13,53,56,57,66,103,132,158,170,172,205,209,223,237,
                           252,276,277,288,380,400,408,416,449,455,466,470,494,
                           495,528,534,540,563,566,579,619,625,655,664,677)]
correct_events <- c("Men's 4 x 10 kilometres Relay", "Women's 4 x 100 metres Relay",
                    "Men's 4 x 100 metres Medley Relay","Men's epee, Individual",
                    "Men's epee, Team","Men's 4 x 100 metres Relay",
                    "Men's 4 x 200 metres Freestyle Relay","Men's 4 x 400 metres Relay",
                    "Women's 4 x 100 metres Medley Relay","Women's epee, Individual",
                    "Men's 4 x 100 metres Freestyle Relay","Men's 4 x 7.5 kilometres Relay",
                    "Women's 4 x 100 metres Freestyle Relay","Women's 4 x 400 metres Relay",
                    "Mixed 2 x 6 kilometres and 2 x 7.5 kilometres Relay","Women's 3 x 5 kilometres Relay",
                    "Women's 3 x 7.5 kilometres Relay","Women's 4 x 7.5 kilometres Relay",
                    "Men's 4 x 50 Yard Freestyle Relay","Women's 4 x 200 metres Freestyle Relay",
                    "Women's 4 x 6 kilometres Relay","Men's 333 metres Time Trial",
                    "Women's 4 x 5 kilometres Relay","Mixed 40 metres",
                    "Men's Kayak Relay 4 x 500 metres","Men's epee, Masters, Individual",
                    "Women's epee, Team","Men's 1/4 mile",
                    "Men's 1/2 mile","Mixed 0.5-1 Ton",
                    "Men's epee, Masters and Amateurs, Individual","Men's 4 x 250 metres Freestyle Relay",
                    "Men's Au Cordon Dore, 50 metres","Mixed 30 metres",
                    "Men's 1/3 mile","Mixed 0-0.5 Ton",
                    "Men's Dueling Pistol Au Vise 20 metres","Men's Sur La Perche a La Herse",
                    "Men's Sur La Perche a La Pyramide","Men's Au Cordon Dore, 33 metres")
length(problem_events) == length(correct_events)
data$Event <- data$Event %>% as.character
for (i in 1:length(problem_events)) {
  data$Event[data$Event == problem_events[i]] <- correct_events[i]
}
data$Event <- data$Event %>% as.factor

# Since some event names can correspond to different sports (e.g., "Men's 100 meters" can be many sports)
# The Event column should include the name of the sport as well
data$Event <- paste(data$Sport, data$Event)
data$Event <- data$Event %>% as.factor
```